<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostBox - Relais & PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        #view-dashboard, .tab-section { display: none; }
        #view-login { display: block; }

        .text-red { color: var(--luxe-red) !important; }
        .btn-gold {
            background: linear-gradient(45deg, var(--luxe-gold), #d4af37);
            color: white; border: none; font-weight: bold;
        }
        .btn-gold:hover { transform: translateY(-2px); color: white; }

        .card-luxury {
            border: none; border-radius: 12px; background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .card-header-luxury {
            background: var(--luxe-red); color: white; padding: 15px;
            border-bottom: 4px solid var(--luxe-gold);
        }

        .nav-pills .nav-link.active { background-color: var(--luxe-red); border-bottom: 2px solid var(--luxe-gold); }
        .nav-pills .nav-link { color: #555; font-weight: 600; margin: 0 5px; }
        .tab-section.active { display: block; animation: slideIn 0.4s; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5" style="max-width: 900px;">
    <div class="text-center mb-5">
        <h1 class="display-4 text-red fw-bold"><i class="fas fa-box-open text-gold"></i> GhostBox</h1>
        <p class="lead text-muted">Relais Postal S√©curis√©</p>
    </div>
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-header-luxury text-center"><h4>Inscription</h4></div>
                <div class="card-body p-4">
                    <input type="email" id="reg-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="reg-pass" class="form-control mb-3" placeholder="Mot de passe">
                    <button onclick="handleRegister()" class="btn btn-gold w-100">Cr√©er Compte</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-body p-5 text-center">
                    <h4 class="text-red mb-3">Connexion</h4>
                    <input type="email" id="login-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="login-pass" class="form-control mb-3" placeholder="Mot de passe">
                    <button onclick="handleLogin()" class="btn btn-outline-danger w-100">Se connecter</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar navbar-light bg-white shadow-sm px-4">
        <div class="container">
            <a class="navbar-brand text-red fw-bold" href="#">GhostBox</a>
            <div>
                <span class="badge bg-warning text-dark me-2" id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">Sortir</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">üì¶ Exp√©dier</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">üè∑Ô∏è Mes √âtiquettes</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-suivi', this)">üì° Suivi</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-adresse', this)">üè† Adresse</a></li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-luxury p-4">
                        <h5 class="text-red border-bottom pb-2">Nouvel Envoi</h5>
                        <label class="fw-bold mt-3">Destinataire (Email)</label>
                        <input type="email" id="send-dest-email" class="form-control mb-3">
                        <div class="row">
                            <div class="col-6">
                                <label class="fw-bold">Format</label>
                                <select class="form-select" id="send-type" onchange="updatePrice()">
                                    <option value="Lettre">‚úâÔ∏è Lettre</option>
                                    <option value="Petit Colis">üì¶ Petit Colis</option>
                                    <option value="Gros Colis">üì¶ Gros Colis</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="fw-bold">Prix</label>
                                <div class="h4 text-red" id="price-display">4.50 ‚Ç¨</div>
                            </div>
                        </div>
                        <button onclick="processShipment()" class="btn btn-gold w-100 mt-4 py-2">Payer & G√©n√©rer</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div class="alert alert-info">Cliquez sur "PDF" pour t√©l√©charger l'√©tiquette √† imprimer.</div>
            <div id="list-labels" class="row g-3">Chargement...</div>
        </div>

        <div id="tab-suivi" class="tab-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3 h-100">
                        <h6>üì§ Envoy√©s</h6>
                        <div id="list-sent" class="list-group list-group-flush">...</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3 h-100">
                        <h6>üì• Re√ßus</h6>
                        <div id="list-received" class="list-group list-group-flush">...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-adresse" class="tab-section">
            <div class="card card-luxury p-4 mx-auto" style="max-width: 600px;">
                <h5 class="text-red">Mon Adresse de R√©ception</h5>
                <input type="text" id="addr-name" class="form-control mb-2" placeholder="Nom">
                <input type="text" id="addr-street" class="form-control mb-2" placeholder="Rue">
                <input type="text" id="addr-city" class="form-control mb-2" placeholder="Ville">
                <button onclick="saveAddress()" class="btn btn-gold w-100">Enregistrer</button>
                <div id="addr-msg" class="text-success text-center mt-2"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}

const auth = firebase.auth();
const db = firebase.firestore();

// --- LOGIQUE ---
auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        document.getElementById('user-email-display').innerText = user.email;
        loadMyAddress(user);
        loadLabels(user);
        loadTracking(user);
    } else {
        document.getElementById('view-login').style.display = 'block';
        document.getElementById('view-dashboard').style.display = 'none';
    }
});

function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
}

function updatePrice() {
    const t = document.getElementById('send-type').value;
    let p = "4.50 ‚Ç¨";
    if(t.includes("Petit")) p = "12.90 ‚Ç¨";
    if(t.includes("Gros")) p = "29.90 ‚Ç¨";
    document.getElementById('price-display').innerText = p;
}

// --- ACTIONS ---
function handleRegister() {
    const e = document.getElementById('reg-email').value;
    const p = document.getElementById('reg-pass').value;
    if(p.length<6) return alert("Mot de passe trop court");
    auth.createUserWithEmailAndPassword(e, p).catch(err => alert(err.message));
}
function handleLogin() {
    const e = document.getElementById('login-email').value;
    const p = document.getElementById('login-pass').value;
    auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
}
function saveAddress() {
    const u = auth.currentUser;
    if(!u) return;
    db.collection('users_addresses').doc(u.uid).set({
        name: document.getElementById('addr-name').value,
        street: document.getElementById('addr-street').value,
        city: document.getElementById('addr-city').value
    }, {merge:true}).then(() => document.getElementById('addr-msg').innerText = "Adresse Sauvegard√©e !");
}
function loadMyAddress(u) {
    db.collection('users_addresses').doc(u.uid).get().then(doc => {
        if(doc.exists) {
            document.getElementById('addr-name').value = doc.data().name || '';
            document.getElementById('addr-street').value = doc.data().street || '';
            document.getElementById('addr-city').value = doc.data().city || '';
        }
    });
}

// --- EXP√âDITION & PDF ---
function processShipment() {
    const dest = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const u = auth.currentUser;
    if(!dest) return alert("Email requis !");
    
    const code = "GB-" + Math.floor(100000 + Math.random() * 900000);
    
    db.collection('shipments').add({
        sender_uid: u.uid,
        sender_email: u.email,
        recipient_email: dest,
        type: type,
        tracking_code: code,
        status: 'paid',
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("Paiement OK ! Allez dans l'onglet 'Mes √âtiquettes'.");
        switchTab('tab-etiquettes');
    });
}

function loadLabels(user) {
    db.collection('shipments').where('sender_uid', '==', user.uid).orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          const div = document.getElementById('list-labels');
          div.innerHTML = '';
          if(snap.empty) { div.innerHTML = '<p class="text-muted text-center">Aucune √©tiquette.</p>'; return; }
          
          snap.forEach(doc => {
              const d = doc.data();
              // ATTENTION : Ici je passe les arguments 1 par 1 pour √©viter les bugs
              const btnHtml = `<button class="btn btn-gold btn-sm" onclick="generatePDF('${d.tracking_code}', '${d.sender_email}', '${d.recipient_email}', '${d.type}')"><i class="fas fa-file-pdf"></i> PDF</button>`;
              
              div.innerHTML += `
              <div class="col-md-6">
                  <div class="card p-3 shadow-sm">
                      <div class="d-flex justify-content-between align-items-center">
                          <div><strong>${d.tracking_code}</strong><br><small>Vers: ${d.recipient_email}</small></div>
                          ${btnHtml}
                      </div>
                  </div>
              </div>`;
          });
      });
}

// GENERATION PDF (Corrig√©e)
async function generatePDF(code, sender, recipient, type) {
    if(!window.jspdf) return alert("Erreur: Librairie PDF non charg√©e. Rafraichissez la page.");
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape', format: 'a6', unit: 'mm' });

    doc.setLineWidth(1);
    doc.rect(2, 2, 144, 101); // Cadre

    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("GHOSTBOX RELAIS", 74, 12, null, null, "center");
    
    doc.setLineWidth(8);
    doc.line(10, 22, 138, 22); // Faux code barre
    doc.setFontSize(10); doc.setFont("courier", "bold");
    doc.text(code, 74, 30, null, null, "center");

    doc.setFont("helvetica", "normal"); doc.setFontSize(9);
    doc.text("EXP: " + sender, 5, 45);
    
    doc.line(2, 55, 146, 55); // Ligne s√©paration

    doc.setFontSize(11); doc.setFont("helvetica", "bold");
    doc.text("DESTINATAIRE (HUB CENTRAL):", 5, 65);
    doc.setFontSize(10); doc.setFont("helvetica", "normal");
    doc.text("GHOSTBOX LOGISTICS", 5, 72);
    doc.text("REF CLIENT: " + recipient, 5, 78);
    doc.text("100 Rue de l'Anonymat, 75000 PARIS", 5, 84);

    doc.setFontSize(8);
    doc.text("Type: " + type + " - Affranchi", 140, 98, null, null, "right");

    doc.save("Etiquette_" + code + ".pdf");
}

function loadTracking(user) {
    db.collection('shipments').where('sender_uid', '==', user.uid).onSnapshot(s => {
        let h = ''; s.forEach(d => h+=`<div class="list-group-item">${d.data().tracking_code} <span class="badge bg-secondary">${d.data().status}</span></div>`);
        document.getElementById('list-sent').innerHTML = h || "Rien.";
    });
    db.collection('shipments').where('recipient_email', '==', user.email).onSnapshot(s => {
        let h = ''; s.forEach(d => h+=`<div class="list-group-item border-start border-3 border-warning">De: ${d.data().sender_email}<br>${d.data().status}</div>`);
        document.getElementById('list-received').innerHTML = h || "Rien.";
    });
}
</script>
</body>
</html>
