<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostBox - Relais Postal Anonyme</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        /* Masquer les vues au chargement */
        #view-dashboard, .tab-section { display: none; }
        #view-login { display: block; }

        /* Couleurs */
        .text-red { color: var(--luxe-red) !important; }
        .text-gold { color: var(--luxe-gold) !important; }
        .bg-red { background-color: var(--luxe-red) !important; }
        
        /* Boutons Dor√©s */
        .btn-gold {
            background: linear-gradient(45deg, var(--luxe-gold), #d4af37);
            color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(184,134,11,0.3);
        }
        .btn-gold:hover { transform: translateY(-2px); color: white; }

        /* Cartes */
        .card-luxury {
            border: none; border-radius: 12px; background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden;
        }
        .card-header-luxury {
            background: var(--luxe-red); color: white; padding: 15px;
            border-bottom: 4px solid var(--luxe-gold);
        }

        /* Navigation */
        .nav-pills .nav-link.active { background-color: var(--luxe-red); border-bottom: 2px solid var(--luxe-gold); }
        .nav-pills .nav-link { color: #555; font-weight: 600; }
        
        /* √âtapes de suivi */
        .timeline-step { font-size: 0.8rem; color: #888; border-left: 2px solid #ddd; padding-left: 15px; margin-left: 5px; }
        .timeline-step.active { color: var(--luxe-red); border-color: var(--luxe-gold); font-weight: bold; }
        
        /* Animation */
        .tab-section.active { display: block; animation: slideIn 0.4s; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5" style="max-width: 900px;">
    <div class="text-center mb-5">
        <h1 class="display-4 text-red fw-bold"><i class="fas fa-box-open text-gold"></i> GhostBox</h1>
        <p class="lead text-muted">La plateforme de relais postal 100% anonyme.</p>
    </div>
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-header-luxury text-center"><h4>Inscription</h4></div>
                <div class="card-body p-4">
                    <input type="email" id="reg-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="reg-pass" class="form-control mb-3" placeholder="Mot de passe">
                    <button onclick="handleRegister()" class="btn btn-gold w-100">Cr√©er un compte</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-body p-5 text-center">
                    <h4 class="text-red mb-3">Connexion</h4>
                    <input type="email" id="login-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="login-pass" class="form-control mb-3" placeholder="Mot de passe">
                    <button onclick="handleLogin()" class="btn btn-outline-danger w-100">Se connecter</button>
                </div>
            </div>
        </div>
    </div>
    <div id="auth-error" class="alert alert-danger d-none mt-3 text-center"></div>
</div>

<div id="view-dashboard">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
        <div class="container">
            <a class="navbar-brand text-red fw-bold" href="#"><i class="fas fa-shipping-fast text-gold"></i> GhostBox</a>
            <div class="d-flex align-items-center">
                <span class="badge bg-warning text-dark me-3" id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">üì¶ Exp√©dier un Colis</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-suivi', this)">üì° Suivi / R√©ception</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-adresse', this)">üè† Mon Adresse R√©elle</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-tarifs', this)">üí∞ Tarifs</a></li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-luxury">
                        <div class="card-header-luxury"><h5>Nouvel Envoi S√©curis√©</h5></div>
                        <div class="card-body p-4">
                            <div class="mb-4">
                                <label class="fw-bold text-red">1. Destinataire (Membre GhostBox)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user-secret"></i></span>
                                    <input type="email" id="send-dest-email" class="form-control" placeholder="Email du destinataire">
                                </div>
                                <small class="text-muted">Nous v√©rifierons s'il est inscrit. Son adresse restera masqu√©e.</small>
                            </div>

                            <div class="mb-4">
                                <label class="fw-bold text-red">2. Caract√©ristiques</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select class="form-select" id="send-type" onchange="calculatePrice()">
                                            <option value="lettre">‚úâÔ∏è Lettre (-100g)</option>
                                            <option value="colis_s">üì¶ Petit Colis (-1kg)</option>
                                            <option value="colis_m">üì¶ Moyen Colis (-5kg)</option>
                                            <option value="colis_l">üì¶ Gros Colis (+5kg)</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <input type="number" id="send-weight" class="form-control" placeholder="Poids (grammes)" oninput="calculatePrice()">
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning border-warning">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Total √† payer :</strong>
                                        <div class="small text-muted">
                                            1. Transport vers Plateforme<br>
                                            2. R√©exp√©dition vers Destinataire
                                        </div>
                                    </div>
                                    <h2 class="text-red mb-0" id="price-display">0.00 ‚Ç¨</h2>
                                </div>
                            </div>

                            <button onclick="processShipment()" class="btn btn-gold w-100 py-3 fs-5">
                                <i class="fas fa-print"></i> Payer & G√©n√©rer l'√âtiquette
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-suivi" class="tab-section">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-red mb-3">üì§ J'ai envoy√©</h5>
                    <div id="list-sent" class="list-group">Chargement...</div>
                </div>
                <div class="col-md-6">
                    <h5 class="text-red mb-3">üì• Je vais recevoir</h5>
                    <div id="list-received" class="list-group">Chargement...</div>
                    <div class="alert alert-info mt-3 small">
                        <i class="fas fa-info-circle"></i> Vous devez avoir renseign√© votre adresse dans l'onglet "Mon Adresse" pour recevoir.
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-adresse" class="tab-section">
            <div class="card card-luxury p-4" style="max-width: 600px; margin: auto;">
                <h4 class="text-red mb-3"><i class="fas fa-map-marker-alt"></i> Mon Adresse de Livraison</h4>
                <p class="text-muted">Ces donn√©es sont chiffr√©es et visibles UNIQUEMENT par la plateforme GhostBox pour la r√©exp√©dition. Aucun exp√©diteur ne verra ceci.</p>
                
                <div class="mb-2"><input type="text" id="addr-name" class="form-control" placeholder="Nom complet"></div>
                <div class="mb-2"><input type="text" id="addr-street" class="form-control" placeholder="Num√©ro et Rue"></div>
                <div class="row mb-3">
                    <div class="col-4"><input type="text" id="addr-zip" class="form-control" placeholder="Code Postal"></div>
                    <div class="col-8"><input type="text" id="addr-city" class="form-control" placeholder="Ville"></div>
                </div>
                <button onclick="saveAddress()" class="btn btn-gold w-100">Enregistrer mes coordonn√©es</button>
                <div id="addr-msg" class="mt-2 text-center text-success fw-bold"></div>
            </div>
        </div>

        <div id="tab-tarifs" class="tab-section">
            <div class="card card-luxury p-4 text-center">
                <h3 class="text-red">Double Affranchissement Inclus</h3>
                <p>Nous calculons automatiquement le co√ªt de l'envoi vers notre Hub + la r√©exp√©dition chez votre correspondant.</p>
                <table class="table mt-4">
                    <thead class="table-light"><tr><th>Type</th><th>Poids</th><th>Tarif Total</th></tr></thead>
                    <tbody>
                        <tr><td>Lettre</td><td>< 100g</td><td><strong>4.50 ‚Ç¨</strong></td></tr>
                        <tr><td>Petit Colis</td><td>< 1kg</td><td><strong>12.90 ‚Ç¨</strong></td></tr>
                        <tr><td>Moyen Colis</td><td>< 5kg</td><td><strong>19.90 ‚Ç¨</strong></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- AUTH & ROUTING ---
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        document.getElementById('user-email-display').innerText = user.email;
        loadMyAddress(user);
        loadShipments(user);
    } else {
        document.getElementById('view-login').style.display = 'block';
        document.getElementById('view-dashboard').style.display = 'none';
    }
});

function handleRegister() {
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    if(pass.length < 6) return alert("Mot de passe trop court");
    auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function handleLogin() {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
}

// --- 1. GESTION ADRESSE (PRIV√âE) ---
function saveAddress() {
    const user = auth.currentUser;
    if(!user) return;
    
    const data = {
        name: document.getElementById('addr-name').value,
        street: document.getElementById('addr-street').value,
        zip: document.getElementById('addr-zip').value,
        city: document.getElementById('addr-city').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    db.collection('users_addresses').doc(user.uid).set(data)
      .then(() => document.getElementById('addr-msg').innerText = "Adresse sauvegard√©e en lieu s√ªr !")
      .catch(e => alert("Erreur : " + e.message));
}

function loadMyAddress(user) {
    db.collection('users_addresses').doc(user.uid).get().then(doc => {
        if(doc.exists) {
            const d = doc.data();
            document.getElementById('addr-name').value = d.name || '';
            document.getElementById('addr-street').value = d.street || '';
            document.getElementById('addr-zip').value = d.zip || '';
            document.getElementById('addr-city').value = d.city || '';
        }
    });
}

// --- 2. LOGIQUE D'ENVOI (EXP√âDITION) ---
function calculatePrice() {
    const type = document.getElementById('send-type').value;
    let price = 0;
    
    // Logique simple de prix (Double affranchissement)
    if(type === 'lettre') price = 4.50;
    else if(type === 'colis_s') price = 12.90;
    else if(type === 'colis_m') price = 19.90;
    else price = 29.90;
    
    document.getElementById('price-display').innerText = price.toFixed(2) + " ‚Ç¨";
}

function processShipment() {
    const destEmail = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const user = auth.currentUser;
    
    if(!destEmail) return alert("Veuillez entrer l'email du destinataire.");

    // Simulation de paiement
    if(!confirm("Confirmer le paiement de " + document.getElementById('price-display').innerText + " ?")) return;

    // Cr√©ation de l'envoi dans la base de donn√©es
    db.collection('shipments').add({
        sender_uid: user.uid,
        sender_email: user.email,
        recipient_email: destEmail, // On stocke l'email, la plateforme fera le lien avec l'adresse
        type: type,
        status: 'paid', // paid -> hub_received -> forwarding -> delivered
        created_at: firebase.firestore.FieldValue.serverTimestamp(),
        tracking_code: "GB-" + Math.floor(Math.random() * 1000000)
    }).then(() => {
        alert("‚úÖ Paiement accept√© !\n\n√âtiquette g√©n√©r√©e. Veuillez coller l'√©tiquette sur votre colis et l'envoyer √† notre plateforme centrale.");
        switchTab('tab-suivi');
        document.getElementById('send-dest-email').value = '';
    }).catch(e => alert("Erreur: " + e.message));
}

// --- 3. SUIVI (SENDER & RECIPIENT) ---
function loadShipments(user) {
    // 1. Ce que j'ai envoy√©
    db.collection('shipments').where('sender_uid', '==', user.uid)
      .orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          let html = '';
          if(snap.empty) html = '<div class="text-muted p-3">Aucun envoi effectu√©.</div>';
          snap.forEach(doc => {
              const d = doc.data();
              const date = d.created_at ? new Date(d.created_at.seconds*1000).toLocaleDateString() : '';
              html += `
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <strong>Vers: ${d.recipient_email}</strong>
                    <span class="badge bg-primary">${d.tracking_code}</span>
                </div>
                <div class="mt-2">
                    ${getStatusBadge(d.status)}
                </div>
                <small class="text-muted">Cr√©√© le ${date}</small>
              </div>`;
          });
          document.getElementById('list-sent').innerHTML = html;
      });

    // 2. Ce que je re√ßois (Bas√© sur mon email)
    db.collection('shipments').where('recipient_email', '==', user.email)
      .orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          let html = '';
          if(snap.empty) html = '<div class="text-muted p-3">Aucune r√©ception en attente.</div>';
          snap.forEach(doc => {
              const d = doc.data();
              html += `
              <div class="list-group-item border-start border-4 border-warning">
                <div class="d-flex justify-content-between">
                    <strong>De: ${d.sender_email}</strong>
                    <span class="badge bg-dark">${d.type}</span>
                </div>
                <p class="mb-1 small">Le colis transite via notre plateforme.</p>
                ${getStatusBadge(d.status)}
                
                <button onclick="advanceStatus('${doc.id}', '${d.status}')" class="btn btn-xs btn-outline-secondary mt-2" style="font-size:0.7rem">
                   [Simuler Avancement Plateforme]
                </button>
              </div>`;
          });
          document.getElementById('list-received').innerHTML = html;
      });
}

function getStatusBadge(status) {
    if(status === 'paid') return '<span class="badge bg-secondary">En attente envoi exp√©diteur</span>';
    if(status === 'hub_received') return '<span class="badge bg-info">Re√ßu Plateforme (R√©√©tiquetage)</span>';
    if(status === 'forwarded') return '<span class="badge bg-warning text-dark">R√©exp√©di√© vers Vous</span>';
    if(status === 'delivered') return '<span class="badge bg-success">Livr√©</span>';
    return status;
}

// Fonction de test pour faire avancer le statut du colis
function advanceStatus(docId, currentStatus) {
    let next = 'hub_received';
    if(currentStatus === 'hub_received') next = 'forwarded';
    if(currentStatus === 'forwarded') next = 'delivered';
    
    db.collection('shipments').doc(docId).update({ status: next });
}

</script>
</body>
</html>
