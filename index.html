<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPseudoMail - Debug Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        /* VUES */
        #view-dashboard { display: none; }
        
        /* STYLES */
        .btn-gold { background: var(--luxe-gold); color: white; border: none; font-weight: bold; }
        .btn-gold:hover { background: #9A7009; color: white; }
        .card-luxury { border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .nav-link.active { background-color: var(--luxe-red) !important; color: white !important; }
        .nav-link { color: var(--luxe-red); }
        .tab-section { display: none; }
        .tab-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5">
    <div class="text-center mb-4">
        <h2 class="text-danger"><i class="fas fa-bug"></i> Mode Diagnostic</h2>
        <p>Si une fen√™tre s'ouvre quand vous cliquez, lisez le message !</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-5 mb-3">
            <div class="card card-luxury p-4">
                <h4>1. S'inscrire d'abord</h4>
                <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email">
                <input type="password" id="reg-pass" class="form-control mb-2" placeholder="Mot de passe">
                <button onclick="handleRegister()" class="btn btn-gold w-100">Cr√©er Compte</button>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card card-luxury p-4 border-danger border-2">
                <h4>2. Se Connecter</h4>
                <input type="email" id="login-email" class="form-control mb-2" placeholder="Votre Email">
                <input type="password" id="login-pass" class="form-control mb-2" placeholder="Votre Mot de passe">
                <button onclick="handleLogin()" class="btn btn-danger w-100">SE CONNECTER (TEST)</button>
            </div>
        </div>
    </div>
</div>

<div id="view-dashboard" class="container-fluid">
    <nav class="navbar navbar-light bg-white px-4 shadow-sm">
        <span class="navbar-brand text-danger fw-bold">MyPseudoMail</span>
        <button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">D√©connexion</button>
    </nav>

    <div class="container py-4">
        <div class="alert alert-success">
            <h4><i class="fas fa-check-circle"></i> SUCC√àS !</h4>
            Vous √™tes bien connect√©. Le syst√®me fonctionne.
            <br>ID: <span id="user-id">...</span>
        </div>

        <ul class="nav nav-pills mb-3">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-inbox', this)">Bo√Æte Mail</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-produits', this)">Produits</a></li>
        </ul>

        <div id="tab-inbox" class="tab-section active">
            <div class="card p-3">
                <h5>Vos Emails</h5>
                <div id="inbox-list">Chargement...</div>
                <button onclick="simulateEmail()" class="btn btn-warning mt-3">Simuler un email</button>
            </div>
        </div>

        <div id="tab-produits" class="tab-section">
            <div class="card p-3"><h5>Nos Produits</h5><p>Contenu des produits ici...</p></div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- 1. GESTION AFFICHAGE ---
auth.onAuthStateChanged((user) => {
    if (user) {
        console.log("Connect√© !");
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        document.getElementById('user-id').innerText = user.email;
        listenInbox(user);
    } else {
        console.log("D√©connect√©");
        document.getElementById('view-login').style.display = 'block';
        document.getElementById('view-dashboard').style.display = 'none';
    }
});

// --- 2. FONCTIONS DE DEBUG ---

function handleRegister() {
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    
    if(!email || !pass) return alert("Veuillez remplir Email et Mot de passe !");

    alert("Tentative de cr√©ation de compte pour : " + email + "...\nVeuillez patienter.");

    auth.createUserWithEmailAndPassword(email, pass)
        .then(() => {
            alert("‚úÖ COMPTE CR√â√â AVEC SUCC√àS !\nVous allez √™tre connect√© automatiquement.");
        })
        .catch((error) => {
            alert("‚ùå ERREUR INSCRIPTION :\n" + error.message);
        });
}

function handleLogin() {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;

    if(!email || !pass) return alert("Les champs sont vides !");

    // ALERTE DE DEBUG
    alert("üöÄ Envoi de la demande √† Firebase pour : " + email);

    auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
            // Si √ßa marche, l'alerte ne s'affichera peut-√™tre pas car la page change vite, 
            // mais le AuthStateChanged prendra le relais.
            console.log("Connexion OK");
        })
        .catch((error) => {
            // C'EST ICI QUE VOUS VERREZ LE PROBL√àME
            alert("‚ùå √âCHEC CONNEXION :\nCode: " + error.code + "\nMessage: " + error.message);
            
            if(error.code === "auth/operation-not-allowed") {
                alert("‚ö†Ô∏è SOLUTION : Vous n'avez pas activ√© 'Email/Password' dans la console Firebase !");
            }
            if(error.code === "auth/user-not-found") {
                alert("‚ö†Ô∏è SOLUTION : Cet email n'existe pas. Cr√©ez un compte d'abord (encadr√© de gauche).");
            }
            if(error.code === "auth/wrong-password") {
                alert("‚ö†Ô∏è SOLUTION : Mot de passe incorrect.");
            }
        });
}

// --- 3. AUTRES FONCTIONS ---
function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(btn) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
    }
}

function listenInbox(user) {
    db.collection('emails').where('to_uid', '==', user.uid).orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
        let html = '';
        snap.forEach(doc => {
            html += `<div class="border-bottom p-2"><b>${doc.data().subject}</b><br>${doc.data().body}</div>`;
        });
        document.getElementById('inbox-list').innerHTML = html || "Aucun message.";
    });
}

function simulateEmail() {
    db.collection('emails').add({
        to_uid: auth.currentUser.uid,
        from: "test@debug.com",
        subject: "Test Diagnostic",
        body: "Ceci prouve que la base de donn√©es fonctionne.",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}
</script>

</body>
</html>
