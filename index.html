<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANCTUM - Espace Membre</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-dark: #2C3E50;
            --accent-gold: #C5A059;
            --bg-body: #E9ECEF;
            --card-bg: #FFFFFF;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Roboto', sans-serif;
            color: #333;
        }

        /* --- NAVIGATION --- */
        .navbar {
            background-color: var(--primary-dark);
            padding: 1rem;
        }
        .navbar-brand {
            font-weight: 700;
            color: white !important;
            letter-spacing: 1px;
        }
        #user-email-display { color: #ccc; font-size: 0.9rem; margin-right: 15px; }

        /* --- ONGLETS --- */
        .nav-pills .nav-link {
            color: #666;
            font-weight: 500;
            margin: 0 5px;
            border-radius: 4px;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-dark);
            color: var(--accent-gold);
            font-weight: bold;
        }
        /* Onglet Admin cach√© par d√©faut */
        #nav-item-admin { display: none !important; }

        /* --- CARTES & BOUTONS --- */
        .card-solid {
            background: white;
            border: 1px solid #ddd;
            border-top: 4px solid var(--primary-dark);
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header-solid {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: var(--primary-dark);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .btn-gold {
            background-color: var(--accent-gold);
            color: white; border: none; font-weight: 600;
            transition: 0.2s;
        }
        .btn-gold:hover { background-color: #b08d4b; color: white; }

        /* --- MODAL PAIEMENT --- */
        #secure-payment-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(4px);
        }
        .payment-window {
            background: white; width: 450px; margin: 80px auto; padding: 0;
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Sections cach√©es par d√©faut */
        #view-dashboard, .tab-section { display: none; }
        .tab-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

<div id="view-login" class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
    <div class="col-md-4">
        <div class="card-solid text-center p-4" style="border-top-color: var(--accent-gold);">
            <h2 class="fw-bold mb-4" style="color: var(--primary-dark);">SANCTUM</h2>
            <input type="email" id="login-email" class="form-control mb-3" placeholder="Email">
            <input type="password" id="login-pass" class="form-control mb-3" placeholder="Mot de passe">
            <button onclick="handleLogin()" class="btn btn-primary w-100 mb-3">Se connecter</button>
            <a href="#" onclick="handleRegister()" class="small text-muted">Cr√©er un compte</a>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i>SANCTUM</a>
            <div class="d-flex align-items-center">
                <span id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-outline-light btn-sm">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills justify-content-center mb-4">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">Nouvel Envoi</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">Mes Bordereaux</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-factures', this)">Mes Factures</a></li>
            <li class="nav-item" id="nav-item-admin">
                <a class="nav-link bg-danger text-white ms-3" href="#" onclick="switchTab('tab-admin', this)"><i class="fas fa-lock"></i> ADMIN</a>
            </li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card-solid">
                        <div class="card-header-solid">Commande d'exp√©dition</div>
                        <div class="p-4">
                            <label class="fw-bold small text-muted">DESTINATAIRE (EMAIL SANCTUM)</label>
                            <input type="email" id="send-dest-email" class="form-control mb-3" placeholder="client@sanctum.io">
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="fw-bold small text-muted">FORMAT</label>
                                    <select class="form-select" id="send-type" onchange="updatePrice()">
                                        <option value="lettre">‚úâÔ∏è Lettre (-100g)</option>
                                        <option value="colis_s">üì¶ Standard (-1kg)</option>
                                        <option value="colis_l">üì¶ Volumineux (+5kg)</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="fw-bold small text-muted">TOTAL √Ä PAYER</label>
                                    <div class="form-control fw-bold text-success text-end" id="price-display">6.50 ‚Ç¨</div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between small text-muted mb-4 px-2">
                                <span>Transporteur : <span id="price-carrier">4.50 ‚Ç¨</span></span>
                                <span>Frais de gestion : <span id="price-fee">2.00 ‚Ç¨</span></span>
                            </div>

                            <button onclick="openPayment()" class="btn btn-gold w-100 py-3 shadow-sm">
                                <i class="fas fa-credit-card me-2"></i> Payer la commande
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div class="card-solid">
                <div class="card-header-solid"><i class="fas fa-tags me-2"></i>Bordereaux d'exp√©dition</div>
                <div class="p-4">
                    <div id="list-labels" class="row g-3">
                        <div class="text-center text-muted">Chargement de vos √©tiquettes...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-factures" class="tab-section">
            <div class="card-solid">
                <div class="card-header-solid"><i class="fas fa-file-invoice-dollar me-2"></i>Historique de facturation</div>
                <div class="p-4">
                    <div id="list-invoices" class="row g-3">
                        <div class="text-center text-muted">Chargement de vos factures...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-admin" class="tab-section">
            <div class="card-solid border-danger">
                <div class="card-header-solid text-danger">Espace Comptable Administrateur</div>
                <div class="p-4">
                    <div class="row text-center mb-4">
                        <div class="col-4 border-end"><h6>CA Total</h6><h3 id="kpi-ca">0‚Ç¨</h3></div>
                        <div class="col-4 border-end"><h6>Co√ªt Poste</h6><h3 id="kpi-cout" class="text-danger">0‚Ç¨</h3></div>
                        <div class="col-4"><h6>Marge</h6><h3 id="kpi-marge" class="text-success">0‚Ç¨</h3></div>
                    </div>
                    <button onclick="exportCSV()" class="btn btn-dark w-100">T√©l√©charger le Grand Livre (CSV)</button>
                    
                    <div class="mt-4">
                        <h6>Journal des √©critures</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark"><tr><th>Date</th><th>Ref</th><th>Total</th><th>Marge</th></tr></thead>
                                <tbody id="table-admin"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="secure-payment-modal">
    <div class="payment-window">
        <div class="p-3 bg-light border-bottom d-flex justify-content-between">
            <strong>Paiement S√©curis√©</strong>
            <button class="btn-close" onclick="closePayment()"></button>
        </div>
        <div class="p-4 text-center">
            <p class="text-muted mb-2">Montant de la transaction</p>
            <h1 class="mb-4" id="pay-amount">0.00 ‚Ç¨</h1>
            <div class="alert alert-light border text-start d-flex align-items-center mb-4">
                <i class="far fa-credit-card fa-2x me-3 text-muted"></i>
                <div><strong>Carte Bancaire</strong><br><small>**** **** **** 4242</small></div>
            </div>
            <button onclick="confirmPayment()" class="btn btn-success w-100 py-3 fw-bold">Valider et T√©l√©charger</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
// --- CONFIGURATION ---
const ADMIN_EMAIL = "annelaure.alibert@gmail.com"; 
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}
const auth = firebase.auth();
const db = firebase.firestore();

const PRICES = { 'lettre': {c:4.5, f:2}, 'colis_s': {c:8.9, f:4}, 'colis_l': {c:15.9, f:6} };
let adminData = [];

// --- LOGIQUE ---
auth.onAuthStateChanged(u => {
    if(u) {
        document.getElementById('view-login').style.display='none';
        document.getElementById('view-dashboard').style.display='block';
        document.getElementById('user-email-display').innerText = u.email;
        
        loadUserLabels(u);
        loadUserInvoices(u);

        // Admin Check
        if(u.email && u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
            document.getElementById('nav-item-admin').style.setProperty('display', 'block', 'important');
            loadAdminData();
        }
    }
});

function switchTab(id, btn) {
    document.querySelectorAll('.tab-section').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
    btn.classList.add('active');
}

function updatePrice() {
    const t = document.getElementById('send-type').value;
    const p = PRICES[t];
    document.getElementById('price-display').innerText = (p.c+p.f).toFixed(2)+" ‚Ç¨";
    document.getElementById('price-carrier').innerText = p.c.toFixed(2)+" ‚Ç¨";
    document.getElementById('price-fee').innerText = p.f.toFixed(2)+" ‚Ç¨";
}

function openPayment() {
    if(!document.getElementById('send-dest-email').value) return alert("Veuillez entrer un destinataire.");
    const t = document.getElementById('send-type').value;
    document.getElementById('pay-amount').innerText = (PRICES[t].c+PRICES[t].f).toFixed(2)+" ‚Ç¨";
    document.getElementById('secure-payment-modal').style.display='block';
}
function closePayment() { document.getElementById('secure-payment-modal').style.display='none'; }

function confirmPayment() {
    const u = auth.currentUser;
    const dest = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const p = PRICES[type];
    const code = "SC"+Math.floor(10000000+Math.random()*90000000);
    const invId = "FAC-"+Math.floor(Math.random()*10000);

    // Save Shipment
    db.collection('shipments').add({
        sender_uid: u.uid, recipient: dest, type: type, code: code,
        date: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Save Invoice
    db.collection('invoices').add({
        user_uid: u.uid, id: invId, date: new Date().toISOString(),
        total: p.c+p.f, cost: p.c, margin: p.f, type: type,
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        closePayment();
        alert("‚úÖ Paiement accept√© ! Le bordereau va se t√©l√©charger.");
        generatePDFLabel(code, u.email, dest); // T√©l√©chargement Auto
        
        // Refresh lists
        setTimeout(() => switchTab('tab-etiquettes', document.querySelectorAll('.nav-link')[1]), 1000);
    });
}

// --- CHARGEMENT DONNEES UTILISATEUR ---
function loadUserLabels(u) {
    db.collection('shipments').where('sender_uid','==',u.uid).orderBy('date','desc').onSnapshot(snap => {
        const div = document.getElementById('list-labels'); div.innerHTML='';
        if(snap.empty) { div.innerHTML = '<div class="text-center text-muted">Aucun envoi pour le moment.</div>'; return; }
        
        snap.forEach(doc => {
            const d = doc.data();
            div.innerHTML += `
            <div class="col-md-6">
                <div class="card p-3 shadow-sm border-start border-5 border-secondary d-flex justify-content-between align-items-center">
                    <div><strong>${d.code}</strong><br><small>Vers: ${d.recipient}</small></div>
                    <button class="btn btn-gold btn-sm" onclick="generatePDFLabel('${d.code}', '${u.email}', '${d.recipient}')">
                        <i class="fas fa-download me-1"></i> T√âL√âCHARGER PDF
                    </button>
                </div>
            </div>`;
        });
    });
}

function loadUserInvoices(u) {
    db.collection('invoices').where('user_uid','==',u.uid).orderBy('created_at','desc').onSnapshot(snap => {
        const div = document.getElementById('list-invoices'); div.innerHTML='';
        if(snap.empty) { div.innerHTML = '<div class="text-center text-muted">Aucune facture.</div>'; return; }

        snap.forEach(doc => {
            const d = doc.data();
            // On cr√©e un objet JSON propre pour le passer √† la fonction
            const invoiceData = { id: d.id, date: d.date, total: d.total, type: d.type };
            // On utilise encodeURIComponent pour passer l'objet proprement dans le HTML
            const dataStr = encodeURIComponent(JSON.stringify(invoiceData));
            
            div.innerHTML += `
            <div class="col-md-6">
                <div class="card p-3 shadow-sm d-flex justify-content-between align-items-center">
                    <div><strong>${d.id}</strong><br>${d.total.toFixed(2)} ‚Ç¨</div>
                    <button class="btn btn-outline-dark btn-sm" onclick="generatePDFInvoice('${dataStr}')">
                        <i class="fas fa-file-pdf me-1"></i> T√âL√âCHARGER
                    </button>
                </div>
            </div>`;
        });
    });
}

// --- ADMIN LOGIC ---
function loadAdminData() {
    db.collection('invoices').orderBy('created_at','desc').onSnapshot(snap => {
        const tbody = document.getElementById('table-admin'); tbody.innerHTML='';
        adminData = []; let ca=0, cout=0, marge=0;
        snap.forEach(doc => {
            const d = doc.data();
            ca+=d.total; cout+=(d.cost||0); marge+=(d.margin||0);
            tbody.innerHTML += `<tr><td>${new Date(d.date).toLocaleDateString()}</td><td>${d.id}</td><td>${d.total}‚Ç¨</td><td class="text-success fw-bold">+${(d.margin||0)}‚Ç¨</td></tr>`;
            adminData.push(d);
        });
        document.getElementById('kpi-ca').innerText = ca.toFixed(2)+" ‚Ç¨";
        document.getElementById('kpi-cout').innerText = cout.toFixed(2)+" ‚Ç¨";
        document.getElementById('kpi-marge').innerText = marge.toFixed(2)+" ‚Ç¨";
    });
}
function exportCSV() {
    let csv = "Date;Ref;Total;Cout;Marge\n";
    adminData.forEach(d => csv += `${d.date};${d.id};${d.total};${d.cost};${d.margin}\n`);
    const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8,"+encodeURI(csv);
    link.download="Compta_Sanctum.csv"; link.click();
}

// --- FONCTIONS PDF PUISSANTES ---
async function generatePDFLabel(code, sender, recipient) {
    alert("G√©n√©ration du Bordereau " + code + " en cours..."); // Feedback Utilisateur
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ format: [100, 150], unit: 'mm' });

    // Design
    doc.setFillColor(44, 62, 80); doc.rect(0,0,100,20,'F');
    doc.setTextColor(255,255,255); doc.setFontSize(16); doc.setFont("helvetica","bold");
    doc.text("SANCTUM RELAIS", 50, 13, null,null,"center");

    doc.setTextColor(0,0,0); doc.setFontSize(10); doc.setFont("helvetica","normal");
    doc.text(`EXP: ${sender}`, 5, 30);
    doc.line(5, 35, 95, 35);

    doc.setFontSize(12); doc.setFont("helvetica","bold"); doc.text("HUB CENTRAL", 5, 45);
    doc.setFontSize(10); doc.setFont("helvetica","normal"); 
    doc.text("14 Rue de la Confidentialit√©", 5, 52);
    doc.text("75000 PARIS", 5, 58);

    doc.rect(5, 65, 90, 15);
    doc.text("REF FINAL:", 7, 70);
    doc.setFont("courier", "bold"); doc.text(recipient, 7, 76);

    // Code Barre
    const canvas = document.createElement("canvas");
    JsBarcode(canvas, code, {format: "CODE128", displayValue: true});
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 5, 90, 90, 30);

    doc.save(`Bordereau_${code}.pdf`);
}

async function generatePDFInvoice(dataStr) {
    alert("T√©l√©chargement de la facture..."); // Feedback
    const data = JSON.parse(decodeURIComponent(dataStr));
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(24); doc.text("SANCTUM", 105, 20, null, null, "center");
    doc.setFontSize(12); doc.text("FACTURE ACQUITT√âE", 105, 30, null, null, "center");
    
    doc.line(20, 40, 190, 40);
    
    doc.text(`R√©f: ${data.id}`, 20, 50);
    doc.text(`Date: ${new Date(data.date).toLocaleDateString()}`, 20, 56);

    doc.text("Description", 20, 80); doc.text("Montant", 160, 80);
    doc.line(20, 82, 190, 82);
    
    doc.text(`Exp√©dition ${data.type}`, 20, 95);
    doc.text(`${data.total.toFixed(2)} ‚Ç¨`, 160, 95);

    doc.setFont("helvetica", "bold");
    doc.text("TOTAL TTC", 120, 120);
    doc.text(`${data.total.toFixed(2)} ‚Ç¨`, 160, 120);

    doc.save(`Facture_${data.id}.pdf`);
}

function handleLogin(){auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
function handleRegister(){auth.createUserWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
</script>
</body>
</html>
