<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostBox - Paiement & Facturation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        #view-dashboard, .tab-section, #secure-payment-modal { display: none; }
        #view-login { display: block; }

        .text-red { color: var(--luxe-red) !important; }
        .text-gold { color: var(--luxe-gold) !important; }
        
        .btn-gold {
            background: linear-gradient(45deg, var(--luxe-gold), #d4af37);
            color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(184,134,11,0.3);
        }
        .btn-gold:hover { transform: translateY(-2px); color: white; }

        .card-luxury { border: none; border-radius: 12px; background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .card-header-luxury { background: var(--luxe-red); color: white; padding: 15px; border-bottom: 4px solid var(--luxe-gold); }
        
        .nav-pills .nav-link.active { background-color: var(--luxe-red); border-bottom: 2px solid var(--luxe-gold); }
        .nav-pills .nav-link { color: #555; font-weight: 600; margin: 0 5px; }
        .tab-section.active { display: block; animation: slideIn 0.4s; }
        
        /* STYLE FACTURE */
        .invoice-box { border: 1px solid #eee; padding: 20px; margin-top: 20px; background: #fff; display:none; }
        .invoice-title { color: var(--luxe-red); font-weight: bold; border-bottom: 2px solid var(--luxe-gold); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* MODAL PAIEMENT SECURISE */
        #secure-payment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .payment-window {
            background: white; width: 400px; margin: 100px auto; padding: 30px;
            border-radius: 10px; text-align: center; position: relative;
        }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5" style="max-width: 900px;">
    <div class="text-center mb-5">
        <h1 class="display-4 text-red fw-bold"><i class="fas fa-box-open text-gold"></i> GhostBox</h1>
        <p class="lead text-muted">Service Premium d'Anonymisation</p>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card card-luxury p-5 text-center">
                <h4 class="text-red mb-3">Connexion</h4>
                <input type="email" id="login-email" class="form-control mb-3" placeholder="admin@test.com">
                <input type="password" id="login-pass" class="form-control mb-3" placeholder="******">
                <button onclick="handleLogin()" class="btn btn-gold w-100">Entrer</button>
                <small class="d-block mt-3 text-muted" onclick="handleRegister()" style="cursor:pointer">Pas de compte ? Cr√©er un compte</small>
            </div>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar navbar-light bg-white shadow-sm px-4">
        <div class="container">
            <a class="navbar-brand text-red fw-bold" href="#">GhostBox</a>
            <div><span class="badge bg-warning text-dark me-2" id="user-email-display">...</span><button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">Sortir</button></div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">üì¶ Nouvel Envoi</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-factures', this)">üìÑ Mes Factures</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">üè∑Ô∏è √âtiquettes</a></li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card card-luxury p-4">
                        <h5 class="text-red border-bottom pb-2">Affranchissement & Services</h5>
                        
                        <label class="fw-bold mt-3">Destinataire (Email GhostBox)</label>
                        <input type="email" id="send-dest-email" class="form-control mb-3" placeholder="destinataire@email.com">
                        
                        <div class="row">
                            <div class="col-12">
                                <label class="fw-bold">Type d'envoi</label>
                                <select class="form-select mb-3" id="send-type" onchange="updateBreakdown()">
                                    <option value="lettre">‚úâÔ∏è Lettre suivie (-100g)</option>
                                    <option value="colis_s">üì¶ Colis Standard (-1kg)</option>
                                    <option value="colis_l">üì¶ Gros Colis (+5kg)</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-light p-3 rounded mb-3 border">
                            <h6 class="fw-bold text-muted">D√©tail de votre commande :</h6>
                            <div class="d-flex justify-content-between">
                                <span>Tarif La Poste/Transporteur</span>
                                <span id="price-carrier">4.50 ‚Ç¨</span>
                            </div>
                            <div class="d-flex justify-content-between text-gold">
                                <span>Frais de Service GhostBox</span>
                                <span id="price-fee">2.00 ‚Ç¨</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-dark">TOTAL √Ä PAYER</strong>
                                <h3 class="text-red mb-0" id="price-total">6.50 ‚Ç¨</h3>
                            </div>
                        </div>

                        <button onclick="openSecurePayment()" class="btn btn-gold w-100 py-2">
                            <i class="fas fa-lock"></i> Payer en toute s√©curit√©
                        </button>
                        <small class="text-muted text-center d-block mt-2"><i class="fas fa-shield-alt"></i> Paiement chiffr√© SSL</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-factures" class="tab-section">
            <div class="alert alert-info">Vos factures d√©taillent les frais de service. L'adresse du destinataire n'y appara√Æt jamais.</div>
            <div id="list-invoices" class="row g-3">Chargement...</div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div id="list-labels" class="row g-3">Chargement...</div>
        </div>
    </div>
</div>

<div id="secure-payment-modal">
    <div class="payment-window shadow-lg">
        <div class="text-end"><button class="btn-close" onclick="closePayment()"></button></div>
        <i class="fas fa-lock fa-3x text-success mb-3"></i>
        <h4>Paiement S√©curis√©</h4>
        <p class="text-muted">Simulateur Bancaire (Stripe/Bank)</p>
        
        <div class="bg-light p-3 rounded mb-4 text-start">
            <small>Commande : <span id="pay-ref">GB-REF</span></small><br>
            <strong>Montant : <span id="pay-amount" class="text-red">...</span></strong>
        </div>

        <div class="mb-3">
            <input type="text" class="form-control mb-2" placeholder="0000 0000 0000 0000" disabled value="**** **** **** 4242">
            <div class="row">
                <div class="col-6"><input type="text" class="form-control" placeholder="MM/AA" disabled value="12/25"></div>
                <div class="col-6"><input type="text" class="form-control" placeholder="CVC" disabled value="***"></div>
            </div>
        </div>

        <button onclick="confirmPayment()" class="btn btn-success w-100 py-2">Valider le paiement</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}
const auth = firebase.auth();
const db = firebase.firestore();

// VARIABLES PRIX
const PRICES = {
    'lettre': { carrier: 4.50, fee: 2.00 },
    'colis_s': { carrier: 8.90, fee: 4.00 },
    'colis_l': { carrier: 15.90, fee: 6.00 }
};

auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        document.getElementById('user-email-display').innerText = user.email;
        loadInvoices(user);
        loadLabels(user);
    }
});

function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
}

// GESTION DES PRIX
function updateBreakdown() {
    const type = document.getElementById('send-type').value;
    const p = PRICES[type];
    const total = p.carrier + p.fee;
    
    document.getElementById('price-carrier').innerText = p.carrier.toFixed(2) + " ‚Ç¨";
    document.getElementById('price-fee').innerText = p.fee.toFixed(2) + " ‚Ç¨";
    document.getElementById('price-total').innerText = total.toFixed(2) + " ‚Ç¨";
}

// GESTION PAIEMENT
function openSecurePayment() {
    if(!document.getElementById('send-dest-email').value) return alert("Email destinataire requis");
    
    const type = document.getElementById('send-type').value;
    const total = (PRICES[type].carrier + PRICES[type].fee).toFixed(2);
    
    document.getElementById('pay-amount').innerText = total + " ‚Ç¨";
    document.getElementById('pay-ref').innerText = "GB-" + Math.floor(Math.random()*100000);
    document.getElementById('secure-payment-modal').style.display = 'block';
}

function closePayment() {
    document.getElementById('secure-payment-modal').style.display = 'none';
}

function confirmPayment() {
    // C'est ici que se ferait l'appel r√©el √† Stripe
    const user = auth.currentUser;
    const dest = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const p = PRICES[type];
    const trackCode = document.getElementById('pay-ref').innerText;

    // 1. Cr√©er l'entr√©e Colis
    db.collection('shipments').add({
        sender_uid: user.uid,
        sender_email: user.email,
        recipient_email: dest,
        type: type,
        tracking_code: trackCode,
        status: 'paid',
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2. Cr√©er la FACTURE (D√©taill√©e)
    db.collection('invoices').add({
        user_uid: user.uid,
        invoice_id: "INV-" + Math.floor(Math.random()*100000),
        date: new Date().toISOString(),
        items: [
            { desc: `Affranchissement ${type}`, amount: p.carrier },
            { desc: "Frais de Service GhostBox", amount: p.fee }
        ],
        total: p.carrier + p.fee,
        recipient_ref: dest, // On garde l'email, mais sur la facture PDF on peut masquer
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        closePayment();
        alert("‚úÖ Paiement Valid√© ! Facture g√©n√©r√©e.");
        switchTab('tab-factures', document.querySelectorAll('.nav-link')[1]);
    });
}

// LISTE DES FACTURES + PDF
function loadInvoices(user) {
    db.collection('invoices').where('user_uid', '==', user.uid).orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          const div = document.getElementById('list-invoices');
          div.innerHTML = '';
          snap.forEach(doc => {
              const d = doc.data();
              const date = new Date(d.created_at.seconds * 1000).toLocaleDateString();
              
              div.innerHTML += `
              <div class="col-md-6">
                  <div class="card p-3 shadow-sm border-start border-4 border-warning">
                      <div class="d-flex justify-content-between align-items-center">
                          <div>
                              <strong>Facture ${d.invoice_id}</strong><br>
                              <small class="text-muted">Du ${date}</small><br>
                              <span class="text-red fw-bold">${d.total.toFixed(2)} ‚Ç¨</span>
                          </div>
                          <button class="btn btn-outline-dark btn-sm" onclick='generateInvoicePDF(${JSON.stringify(d)})'>
                              <i class="fas fa-file-invoice"></i> T√©l√©charger
                          </button>
                      </div>
                  </div>
              </div>`;
          });
      });
}

// GENERATEUR DE FACTURE PDF
async function generateInvoicePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // En-t√™te
    doc.setFontSize(20); doc.setTextColor(139, 0, 0);
    doc.text("GHOSTBOX - FACTURE", 105, 20, null, null, "center");
    
    doc.setFontSize(10); doc.setTextColor(0, 0, 0);
    doc.text("GhostBox Services", 10, 30);
    doc.text("14 Avenue de l'Anonymat", 10, 35);
    doc.text("75000 PARIS - FRANCE", 10, 40);

    doc.text("Client Exp√©diteur : " + auth.currentUser.email, 140, 30);
    doc.text("N¬∞ Facture : " + data.invoice_id, 140, 35);
    doc.text("Date : " + new Date(data.date).toLocaleDateString(), 140, 40);

    // Ligne
    doc.setLineWidth(0.5); doc.line(10, 50, 200, 50);

    // Tableau
    let y = 60;
    doc.setFont("helvetica", "bold");
    doc.text("Description", 10, y);
    doc.text("Montant", 170, y);
    y += 10;
    doc.setFont("helvetica", "normal");

    // Items
    data.items.forEach(item => {
        doc.text(item.desc, 10, y);
        doc.text(item.amount.toFixed(2) + " ‚Ç¨", 170, y);
        y += 10;
    });

    y += 5;
    doc.line(10, y, 200, y);
    y += 10;

    // Total
    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("TOTAL PAY√â TTC :", 120, y);
    doc.text(data.total.toFixed(2) + " ‚Ç¨", 170, y);

    // Note de confidentialit√©
    y += 30;
    doc.setFontSize(8); doc.setFont("helvetica", "italic"); doc.setTextColor(100);
    doc.text("Note de confidentialit√© : Cette facture concerne l'envoi vers le destinataire r√©f. " + data.recipient_ref, 10, y);
    doc.text("L'adresse postale du destinataire n'est pas stock√©e sur ce document pour garantir l'anonymat.", 10, y+5);

    doc.save(`Facture-${data.invoice_id}.pdf`);
}

// CHARGEMENT ETIQUETTES SIMPLIFIE
function loadLabels(user) {
    db.collection('shipments').where('sender_uid', '==', user.uid).onSnapshot(s => {
        const d = document.getElementById('list-labels'); d.innerHTML = '';
        s.forEach(doc => {
             d.innerHTML += `<div class="col-md-4"><div class="card p-3"><small>${doc.data().tracking_code}</small><strong>${doc.data().type}</strong></div></div>`;
        });
    });
}

function handleRegister() { auth.createUserWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e=>alert(e.message)); }
function handleLogin() { auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e=>alert(e.message)); }
</script>
</body>
</html>
