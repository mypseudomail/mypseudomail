<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostBox - Admin & Compta</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        #view-dashboard, .tab-section, #secure-payment-modal { display: none; }
        #view-login { display: block; }

        .text-red { color: var(--luxe-red) !important; }
        .btn-gold {
            background: linear-gradient(45deg, var(--luxe-gold), #d4af37);
            color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(184,134,11,0.3);
        }
        .btn-gold:hover { transform: translateY(-2px); color: white; }

        .card-luxury { border: none; border-radius: 12px; background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .card-header-luxury { background: var(--luxe-red); color: white; padding: 15px; border-bottom: 4px solid var(--luxe-gold); }
        
        .nav-pills .nav-link.active { background-color: var(--luxe-red); border-bottom: 2px solid var(--luxe-gold); }
        .nav-pills .nav-link { color: #555; font-weight: 600; margin: 0 5px; }
        .tab-section.active { display: block; animation: slideIn 0.4s; }
        
        /* Modal Paiement */
        #secure-payment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; backdrop-filter: blur(5px);
        }
        .payment-window {
            background: white; width: 400px; margin: 100px auto; padding: 30px;
            border-radius: 10px; text-align: center; position: relative;
        }

        /* STYLE TABLEAU COMPTA */
        .table-compta th { background-color: #333; color: white; }
        .row-total { background-color: #fff3cd; font-weight: bold; }

        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5" style="max-width: 900px;">
    <div class="text-center mb-5">
        <h1 class="display-4 text-red fw-bold"><i class="fas fa-box-open text-gold"></i> GhostBox</h1>
        <p class="lead text-muted">Plateforme Logistique & Administration</p>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card card-luxury p-5 text-center">
                <h4 class="text-red mb-3">Espace Membre</h4>
                <input type="email" id="login-email" class="form-control mb-3" placeholder="Email">
                <input type="password" id="login-pass" class="form-control mb-3" placeholder="Mot de passe">
                <button onclick="handleLogin()" class="btn btn-gold w-100">Entrer</button>
                <div class="mt-3 text-muted small" style="cursor:pointer" onclick="handleRegister()">Cr√©er un compte</div>
            </div>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar navbar-light bg-white shadow-sm px-4">
        <div class="container">
            <a class="navbar-brand text-red fw-bold" href="#">GhostBox</a>
            <div>
                <span class="badge bg-warning text-dark me-2" id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">Sortir</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">üì¶ Exp√©dier</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">üè∑Ô∏è √âtiquettes</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-factures', this)">üìÑ Factures</a></li>
            <li class="nav-item"><a class="nav-link bg-dark text-white ms-3" href="#" onclick="switchTab('tab-admin', this)">üìä Admin / Compta</a></li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card card-luxury p-4">
                        <h5 class="text-red border-bottom pb-2">Cr√©er un bordereau</h5>
                        
                        <label class="fw-bold mt-3">Destinataire (Email)</label>
                        <input type="email" id="send-dest-email" class="form-control mb-3" placeholder="client@email.com">
                        
                        <label class="fw-bold">Poids / Format</label>
                        <select class="form-select mb-3" id="send-type" onchange="updateBreakdown()">
                            <option value="lettre">‚úâÔ∏è Lettre (-100g)</option>
                            <option value="colis_s">üì¶ Colis S (-1kg)</option>
                            <option value="colis_l">üì¶ Colis L (+5kg)</option>
                        </select>

                        <div class="bg-light p-3 rounded mb-3 border">
                            <div class="d-flex justify-content-between"><span>Co√ªt Transporteur (La Poste)</span><span id="price-carrier">4.50 ‚Ç¨</span></div>
                            <div class="d-flex justify-content-between text-gold"><span>Marge / Service GhostBox</span><span id="price-fee">2.00 ‚Ç¨</span></div>
                            <hr>
                            <div class="d-flex justify-content-between"><strong>TOTAL A PAYER</strong><h4 class="text-red mb-0" id="price-total">6.50 ‚Ç¨</h4></div>
                        </div>

                        <button onclick="openSecurePayment()" class="btn btn-gold w-100 py-2"><i class="fas fa-lock"></i> Payer</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div id="list-labels" class="row g-3">Chargement...</div>
        </div>

        <div id="tab-factures" class="tab-section">
            <div id="list-invoices" class="row g-3">Chargement...</div>
        </div>

        <div id="tab-admin" class="tab-section">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white p-3 shadow-sm h-100">
                        <h3><i class="fas fa-wallet"></i> <span id="kpi-ca">0.00 ‚Ç¨</span></h3>
                        <p class="mb-0">Chiffre d'Affaires Total (Encaiiss√©)</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger text-white p-3 shadow-sm h-100">
                        <h3><i class="fas fa-truck"></i> <span id="kpi-cout">0.00 ‚Ç¨</span></h3>
                        <p class="mb-0">Co√ªt Transporteurs (√Ä payer √† La Poste)</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white p-3 shadow-sm h-100">
                        <h3><i class="fas fa-coins"></i> <span id="kpi-marge">0.00 ‚Ç¨</span></h3>
                        <p class="mb-0">Marge Nette (Avant Imp√¥ts)</p>
                    </div>
                </div>
            </div>

            <div class="card card-luxury p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-red">Journal des Ventes</h5>
                    <button onclick="exportToCSV()" class="btn btn-dark"><i class="fas fa-file-csv"></i> Exporter Excel/CSV</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-compta text-center">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Facture #</th>
                                <th>Total (TTC)</th>
                                <th>Bordereau (Co√ªt)</th>
                                <th>Marge (Service)</th>
                                <th>TVA (20% sur Marge)</th>
                            </tr>
                        </thead>
                        <tbody id="table-compta-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="secure-payment-modal">
    <div class="payment-window shadow-lg">
        <div class="text-end"><button class="btn-close" onclick="closePayment()"></button></div>
        <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
        <h4>Paiement S√©curis√©</h4>
        <div class="bg-light p-3 rounded mb-4"><strong>Montant : <span id="pay-amount" class="text-red">...</span></strong></div>
        <button onclick="confirmPayment()" class="btn btn-success w-100">Valider</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}
const auth = firebase.auth();
const db = firebase.firestore();

// PRIX ET MARGES (c=Co√ªt transporteur, f=Frais service/Marge)
const PRICES = { 'lettre': {c:4.5, f:2}, 'colis_s': {c:8.9, f:4}, 'colis_l': {c:15.9, f:6} };

// STOCKAGE GLOBAL POUR EXPORT
let accountingData = [];

auth.onAuthStateChanged(u => {
    if(u) {
        document.getElementById('view-login').style.display='none';
        document.getElementById('view-dashboard').style.display='block';
        document.getElementById('user-email-display').innerText=u.email;
        loadLabels(u); loadInvoices(u); loadAccounting();
    }
});

function switchTab(id, btn) {
    document.querySelectorAll('.tab-section').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
    btn.classList.add('active');
}

// --- 1. PAIEMENT & FACTURATION ---
function updateBreakdown() {
    const t = document.getElementById('send-type').value;
    const p = PRICES[t];
    document.getElementById('price-carrier').innerText = p.c.toFixed(2)+" ‚Ç¨";
    document.getElementById('price-fee').innerText = p.f.toFixed(2)+" ‚Ç¨";
    document.getElementById('price-total').innerText = (p.c+p.f).toFixed(2)+" ‚Ç¨";
}

function openSecurePayment() {
    const t = document.getElementById('send-type').value;
    document.getElementById('pay-amount').innerText = (PRICES[t].c+PRICES[t].f).toFixed(2)+" ‚Ç¨";
    document.getElementById('secure-payment-modal').style.display='block';
}
function closePayment() { document.getElementById('secure-payment-modal').style.display='none'; }

function confirmPayment() {
    const u = auth.currentUser;
    const dest = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const p = PRICES[type];
    const code = "GB"+Math.floor(1000000000 + Math.random() * 9000000000);
    const invId = "FAC-"+Math.floor(Math.random()*10000);

    // Cr√©ation Colis
    db.collection('shipments').add({
        sender_uid: u.uid, sender_email: u.email, recipient_email: dest,
        type: type, tracking_code: code, status: 'paid',
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Cr√©ation Facture (Donn√©es structur√©es pour la compta)
    db.collection('invoices').add({
        user_uid: u.uid, 
        invoice_id: invId,
        date: new Date().toISOString(), 
        total: p.c+p.f,
        cost_carrier: p.c,   // IMPORTANT : On stocke le co√ªt
        margin_service: p.f, // IMPORTANT : On stocke la marge
        items: [{d:`Affranchissement ${type}`, a:p.c}, {d:"Frais GhostBox", a:p.f}],
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        closePayment();
        alert("Paiement OK ! Comptabilit√© mise √† jour.");
        loadAccounting(); // Rafraichir la compta
    });
}

// --- 2. MODULE COMPTABILIT√â (LE COEUR DU SUJET) ---
function loadAccounting() {
    // Note: Pour une vraie app, on s√©curiserait cette requ√™te c√¥t√© serveur.
    // Ici on charge TOUTES les factures de la base pour le rapport admin.
    db.collection('invoices').orderBy('created_at', 'desc').onSnapshot(snap => {
        const tbody = document.getElementById('table-compta-body');
        tbody.innerHTML = '';
        accountingData = []; // Reset pour l'export CSV
        
        let totalCA = 0;
        let totalCout = 0;
        let totalMarge = 0;

        snap.forEach(doc => {
            const d = doc.data();
            // Calculs de base
            const carrier = d.cost_carrier || 0;
            const margin = d.margin_service || 0;
            // TVA estim√©e (20% sur la marge uniquement, pas sur le timbre souvent exon√©r√© en refacturation)
            // Ou TVA sur tout selon votre statut. Ici on fait simple : TVA sur la marge.
            const tva = margin * 0.20; 
            
            totalCA += d.total;
            totalCout += carrier;
            totalMarge += margin;

            const dateStr = new Date(d.date).toLocaleDateString();

            // Ajout au tableau HTML
            tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>${d.invoice_id}</td>
                <td>${d.total.toFixed(2)} ‚Ç¨</td>
                <td class="text-danger">-${carrier.toFixed(2)} ‚Ç¨</td>
                <td class="text-success fw-bold">+${margin.toFixed(2)} ‚Ç¨</td>
                <td class="text-muted small">${tva.toFixed(2)} ‚Ç¨</td>
            </tr>`;

            // Ajout aux donn√©es pour l'export CSV
            accountingData.push({
                date: dateStr,
                id: d.invoice_id,
                ca: d.total,
                cout: carrier,
                marge: margin,
                tva: tva
            });
        });

        // Mise √† jour des cartes KPI
        document.getElementById('kpi-ca').innerText = totalCA.toFixed(2) + " ‚Ç¨";
        document.getElementById('kpi-cout').innerText = totalCout.toFixed(2) + " ‚Ç¨";
        document.getElementById('kpi-marge').innerText = totalMarge.toFixed(2) + " ‚Ç¨";
    });
}

// --- 3. EXPORT CSV (POUR VOTRE COMPTABLE) ---
function exportToCSV() {
    if(accountingData.length === 0) return alert("Aucune donn√©e √† exporter.");

    // En-t√™te du fichier CSV
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Date;Num Facture;Total Encaisse (TTC);Cout Bordereau;Marge Brute;TVA Estimee (20% Marge)\n";

    // Lignes
    accountingData.forEach(row => {
        const line = `${row.date};${row.id};${row.ca.toFixed(2)};${row.cout.toFixed(2)};${row.marge.toFixed(2)};${row.tva.toFixed(2)}`;
        csvContent += line + "\n";
    });

    // T√©l√©chargement
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "GhostBox_Compta_" + new Date().toISOString().slice(0,10) + ".csv");
    document.body.appendChild(link);
    link.click();
}

// --- AUTRES FONCTIONS D'AFFICHAGE ---
function loadLabels(u) {
    db.collection('shipments').where('sender_uid','==',u.uid).orderBy('created_at','desc').onSnapshot(s=>{
        document.getElementById('list-labels').innerHTML = '';
        s.forEach(doc => {
            const d = doc.data();
            document.getElementById('list-labels').innerHTML += `<div class="col-md-4"><div class="card p-3"><strong>${d.tracking_code}</strong><br>${d.type}<br><button class="btn btn-sm btn-gold mt-2" onclick="alert('Impression PDF...')">Imprimer</button></div></div>`;
        });
    });
}
function loadInvoices(u) {
    db.collection('invoices').where('user_uid','==',u.uid).orderBy('created_at','desc').onSnapshot(s=>{
        document.getElementById('list-invoices').innerHTML = '';
        s.forEach(doc => {
            const d = doc.data();
            document.getElementById('list-invoices').innerHTML += `<div class="col-md-4"><div class="card p-3">Facture ${d.invoice_id}<br>${d.total}‚Ç¨</div></div>`;
        });
    });
}
function handleLogin(){auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
function handleRegister(){auth.createUserWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
</script>
</body>
</html>
