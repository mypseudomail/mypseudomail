<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostBox - Relais Postal & √âtiquettes</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --luxe-red: #8B0000; --luxe-gold: #B8860B; --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        /* Masquage initial */
        #view-dashboard, .tab-section { display: none; }
        #view-login { display: block; }

        /* Couleurs Luxe */
        .text-red { color: var(--luxe-red) !important; }
        .text-gold { color: var(--luxe-gold) !important; }
        .btn-gold {
            background: linear-gradient(45deg, var(--luxe-gold), #d4af37);
            color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(184,134,11,0.3);
        }
        .btn-gold:hover { transform: translateY(-2px); color: white; }

        .card-luxury {
            border: none; border-radius: 12px; background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden;
        }
        .card-header-luxury {
            background: var(--luxe-red); color: white; padding: 15px;
            border-bottom: 4px solid var(--luxe-gold);
        }

        /* Navigation */
        .nav-pills .nav-link.active { background-color: var(--luxe-red); border-bottom: 2px solid var(--luxe-gold); }
        .nav-pills .nav-link { color: #555; font-weight: 600; margin: 0 5px; }
        
        /* Animation */
        .tab-section.active { display: block; animation: slideIn 0.4s; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container py-5" style="max-width: 900px;">
    <div class="text-center mb-5">
        <h1 class="display-4 text-red fw-bold"><i class="fas fa-box-open text-gold"></i> GhostBox</h1>
        <p class="lead text-muted">Relais Postal Anonyme S√©curis√©</p>
    </div>
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-header-luxury text-center"><h4>Inscription</h4></div>
                <div class="card-body p-4">
                    <input type="email" id="reg-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="reg-pass" class="form-control mb-3" placeholder="Mot de passe (6+ car.)">
                    <button onclick="handleRegister()" class="btn btn-gold w-100">Cr√©er un compte</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-luxury h-100">
                <div class="card-body p-5 text-center">
                    <h4 class="text-red mb-3">Connexion</h4>
                    <input type="email" id="login-email" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="login-pass" class="form-control mb-3" placeholder="Mot de passe">
                    <button onclick="handleLogin()" class="btn btn-outline-danger w-100">Se connecter</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
        <div class="container">
            <a class="navbar-brand text-red fw-bold" href="#"><i class="fas fa-shipping-fast text-gold"></i> GhostBox</a>
            <div class="d-flex align-items-center">
                <span class="badge bg-warning text-dark me-3" id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-sm btn-outline-dark">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">üì¶ Exp√©dier</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">üè∑Ô∏è Mes √âtiquettes</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-suivi', this)">üì° Suivi</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-adresse', this)">üè† Mon Adresse</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-tarifs', this)">üí∞ Tarifs</a></li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-luxury">
                        <div class="card-header-luxury"><h5>Nouvel Envoi</h5></div>
                        <div class="card-body p-4">
                            <div class="mb-3">
                                <label class="fw-bold text-red">Destinataire (Email GhostBox)</label>
                                <input type="email" id="send-dest-email" class="form-control" placeholder="ami@test.com">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="fw-bold">Format</label>
                                    <select class="form-select" id="send-type" onchange="calculatePrice()">
                                        <option value="Lettre">‚úâÔ∏è Lettre</option>
                                        <option value="Petit Colis">üì¶ Petit Colis</option>
                                        <option value="Gros Colis">üì¶ Gros Colis</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="fw-bold">Poids (g)</label>
                                    <input type="number" id="send-weight" class="form-control" placeholder="Ex: 500">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-3">
                                <strong>Total √† payer :</strong>
                                <h3 class="text-red mb-0" id="price-display">4.50 ‚Ç¨</h3>
                            </div>
                            <button onclick="processShipment()" class="btn btn-gold w-100 py-2">
                                <i class="fas fa-credit-card"></i> Payer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Voici vos √©tiquettes pay√©es. Cliquez sur "PDF" pour t√©l√©charger et imprimer.
            </div>
            <div id="list-labels" class="row g-3">
                <div class="text-center p-5 text-muted">Chargement...</div>
            </div>
        </div>

        <div id="tab-suivi" class="tab-section">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-light fw-bold">üì§ Colis Envoy√©s (Statut)</div>
                        <div id="list-sent" class="list-group list-group-flush">Chargement...</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light fw-bold">üì• Colis Attendus</div>
                        <div id="list-received" class="list-group list-group-flush">Chargement...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-adresse" class="tab-section">
            <div class="card card-luxury p-4 mx-auto" style="max-width: 600px;">
                <h4 class="text-red">Mon Adresse de R√©ception</h4>
                <p class="small text-muted">N√©cessaire pour recevoir des colis.</p>
                <input type="text" id="addr-name" class="form-control mb-2" placeholder="Nom complet">
                <input type="text" id="addr-street" class="form-control mb-2" placeholder="Rue">
                <div class="row">
                    <div class="col-4"><input type="text" id="addr-zip" class="form-control" placeholder="CP"></div>
                    <div class="col-8"><input type="text" id="addr-city" class="form-control" placeholder="Ville"></div>
                </div>
                <button onclick="saveAddress()" class="btn btn-gold w-100 mt-3">Enregistrer</button>
                <div id="addr-msg" class="mt-2 text-success text-center"></div>
            </div>
        </div>

        <div id="tab-tarifs" class="tab-section text-center">
            <div class="card card-luxury p-4">
                <h3>Tarifs Uniques</h3>
                <p>Inclut l'anonymisation et la r√©exp√©dition.</p>
                <div class="row mt-4">
                    <div class="col-4"><h4>4.50‚Ç¨</h4><small>Lettre</small></div>
                    <div class="col-4"><h4>12.90‚Ç¨</h4><small>Colis Standard</small></div>
                    <div class="col-4"><h4>29.90‚Ç¨</h4><small>Gros Colis</small></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// 1. CONFIG FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}

const auth = firebase.auth();
const db = firebase.firestore();

// 2. ROUTING ET CHARGEMENT
auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        document.getElementById('user-email-display').innerText = user.email;
        loadMyAddress(user);
        loadShipments(user);
        loadLabels(user); // Chargement des √©tiquettes
    } else {
        document.getElementById('view-login').style.display = 'block';
        document.getElementById('view-dashboard').style.display = 'none';
    }
});

// 3. ACTIONS DE BASE
function handleRegister() {
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    if(pass.length < 6) return alert("Mot de passe trop court");
    auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function handleLogin() {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
}

function calculatePrice() {
    const type = document.getElementById('send-type').value;
    let p = 4.50;
    if(type.includes("Petit")) p = 12.90;
    if(type.includes("Gros")) p = 29.90;
    document.getElementById('price-display').innerText = p.toFixed(2) + " ‚Ç¨";
}

// 4. GESTION ADRESSE
function saveAddress() {
    const user = auth.currentUser;
    if(!user) return;
    db.collection('users_addresses').doc(user.uid).set({
        name: document.getElementById('addr-name').value,
        street: document.getElementById('addr-street').value,
        zip: document.getElementById('addr-zip').value,
        city: document.getElementById('addr-city').value
    }, { merge: true }).then(() => document.getElementById('addr-msg').innerText = "Adresse OK !");
}

function loadMyAddress(user) {
    db.collection('users_addresses').doc(user.uid).get().then(doc => {
        if(doc.exists) {
            const d = doc.data();
            document.getElementById('addr-name').value = d.name || '';
            document.getElementById('addr-street').value = d.street || '';
            document.getElementById('addr-zip').value = d.zip || '';
            document.getElementById('addr-city').value = d.city || '';
        }
    });
}

// 5. EXP√âDITION
function processShipment() {
    const dest = document.getElementById('send-dest-email').value;
    const user = auth.currentUser;
    
    if(!dest) return alert("Email destinataire manquant !");
    
    const trackCode = "GB-" + Math.floor(100000 + Math.random() * 900000);

    db.collection('shipments').add({
        sender_uid: user.uid,
        sender_email: user.email,
        recipient_email: dest,
        status: 'paid',
        tracking_code: trackCode,
        type: document.getElementById('send-type').value,
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("‚úÖ Paiement valid√© !\nVotre √©tiquette est disponible dans l'onglet 'Mes √âtiquettes'.");
        switchTab('tab-etiquettes'); // Redirection auto
    });
}

// 6. AFFICHAGE DES √âTIQUETTES + G√âN√âRATION PDF
function loadLabels(user) {
    db.collection('shipments').where('sender_uid', '==', user.uid)
      .orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          const container = document.getElementById('list-labels');
          container.innerHTML = '';
          
          if(snap.empty) {
              container.innerHTML = '<div class="text-center p-5 text-muted">Aucune √©tiquette √† imprimer.</div>';
              return;
          }

          snap.forEach(doc => {
             const d = doc.data();
             // On cr√©e un √©l√©ment visuel pour l'√©tiquette
             const col = document.createElement('div');
             col.className = 'col-md-6';
             col.innerHTML = `
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 text-red fw-bold">${d.tracking_code}</h5>
                            <small class="text-muted">Vers: ${d.recipient_email}</small><br>
                            <span class="badge bg-light text-dark border">${d.type}</span>
                        </div>
                        <button class="btn btn-gold btn-sm" onclick='generatePDF(${JSON.stringify(d)})'>
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
             `;
             container.appendChild(col);
          });
      });
}

// FONCTION MAGIQUE : G√âN√âRATION DU PDF
async function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a6' // Format √©tiquette standard
    });

    // Cadre
    doc.setLineWidth(1);
    doc.rect(5, 5, 138, 95);

    // En-t√™te
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("GHOSTBOX RELAIS", 74, 15, null, null, "center");
    
    // Code barre (simulation visuelle)
    doc.setLineWidth(10);
    doc.line(20, 25, 128, 25); // Grosse barre noire
    doc.setFontSize(10);
    doc.setFont("courier", "normal");
    doc.text("* " + data.tracking_code + " *", 74, 32, null, null, "center");

    // Exp√©diteur
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("EXP√âDITEUR (VOUS):", 10, 45);
    doc.setFont("helvetica", "normal");
    doc.text(data.sender_email, 10, 50);

    // Ligne s√©paration
    doc.setLineWidth(0.5);
    doc.line(5, 60, 143, 60);

    // Destinataire (HUB)
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("√Ä ENVOYER AU HUB CENTRAL :", 10, 70);
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("GHOSTBOX LOGISTICS CENTER", 10, 75);
    doc.text("Ref Destinataire: " + data.recipient_email, 10, 80);
    doc.text("14 Avenue de l'Anonymat, 75000 PARIS", 10, 85);

    // Pied de page
    doc.setFontSize(8);
    doc.text("Affranchissement pay√© - Type: " + data.type, 10, 95);

    // Sauvegarde
    doc.save(`Etiquette-${data.tracking_code}.pdf`);
}

// 7. CHARGEMENT DU SUIVI
function loadShipments(user) {
    // Suivi simple (sans bouton PDF)
    db.collection('shipments').where('sender_uid', '==', user.uid).orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          let html = '';
          snap.forEach(doc => {
             const d = doc.data();
             html += `<div class="list-group-item d-flex justify-content-between">
                <span>Vers ${d.recipient_email}</span>
                <span class="badge bg-secondary">${d.status}</span>
             </div>`;
          });
          document.getElementById('list-sent').innerHTML = html;
      });

    db.collection('shipments').where('recipient_email', '==', user.email).orderBy('created_at', 'desc')
      .onSnapshot(snap => {
          let html = '';
          snap.forEach(doc => {
             const d = doc.data();
             html += `<div class="list-group-item border-warning border-start border-3">
                <strong>De: ${d.sender_email}</strong><br>
                <span class="badge bg-primary">${d.status}</span>
             </div>`;
          });
          document.getElementById('list-received').innerHTML = html;
      });
}
</script>
</body>
</html>
