<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANCTUM - Confidentialit√© & Exp√©dition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --sanctum-black: #1a1a1a;
            --sanctum-gold: #C5A059;
            --sanctum-paper: #F9F9F7; /* Blanc cass√© √©l√©gant */
            --sanctum-white: #ffffff;
            --sanctum-grey: #f0f0f0;
        }

        body {
            background-color: var(--sanctum-paper);
            font-family: 'Montserrat', sans-serif;
            color: var(--sanctum-black);
        }

        h1, h2, h3, h4, h5, .navbar-brand {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* --- NAVIGATION --- */
        .navbar {
            background-color: var(--sanctum-white);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1rem 2rem;
        }
        .navbar-brand {
            font-size: 1.8rem;
            color: var(--sanctum-black) !important;
        }

        /* --- BOUTONS --- */
        .btn-gold {
            background-color: var(--sanctum-black);
            color: var(--sanctum-gold);
            border: 1px solid var(--sanctum-black);
            border-radius: 2px; /* Angles plus droits = plus classique */
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
            padding: 10px 20px;
            transition: all 0.4s ease;
        }
        .btn-gold:hover {
            background-color: var(--sanctum-gold);
            color: var(--sanctum-black);
            border-color: var(--sanctum-gold);
        }

        /* --- CARTES --- */
        .card-classic {
            background: var(--sanctum-white);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); /* Ombre tr√®s douce */
            padding: 2rem;
        }
        .card-header-classic {
            border-bottom: 1px solid var(--sanctum-gold);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--sanctum-black);
            text-align: center;
        }

        /* --- INPUTS --- */
        .form-control, .form-select {
            border-radius: 2px;
            border: 1px solid #ddd;
            background-color: #fafafa;
            padding: 12px;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: var(--sanctum-gold);
        }

        /* --- ONGLETS (TABS) --- */
        .nav-pills .nav-link {
            color: #888;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            background: transparent;
            border-radius: 0;
            margin: 0 15px;
            padding-bottom: 5px;
        }
        .nav-pills .nav-link.active {
            background-color: transparent;
            color: var(--sanctum-black);
            border-bottom: 2px solid var(--sanctum-gold);
            font-weight: bold;
        }

        /* --- UTILITAIRES --- */
        .text-gold { color: var(--sanctum-gold) !important; }
        #view-dashboard, .tab-section, #secure-payment-modal { display: none; }
        #nav-item-admin { display: none; }

        /* --- MODAL PAIEMENT --- */
        #secure-payment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); /* Fond blanc flou pour effet luxe */
            z-index: 9999; backdrop-filter: blur(8px);
        }
        .payment-window {
            background: #fff; width: 450px; margin: 80px auto; padding: 40px;
            border: 1px solid #eee; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            text-align: center; position: relative;
        }

        /* Animation douce */
        .tab-section.active { display: block; animation: fadeIn 0.6s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="view-login" class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
    <div class="col-md-5">
        <div class="card-classic text-center">
            <div class="mb-4">
                <i class="fas fa-shield-alt fa-2x text-gold mb-3"></i>
                <h1 class="display-5">SANCTUM</h1>
                <p class="text-muted small text-uppercase" style="letter-spacing: 2px;">Service Priv√© & Confidentiel</p>
            </div>
            
            <div class="mb-3 text-start">
                <label class="small text-muted mb-1">Identifiant</label>
                <input type="email" id="login-email" class="form-control" placeholder="votre@email.com">
            </div>
            <div class="mb-4 text-start">
                <label class="small text-muted mb-1">Mot de passe</label>
                <input type="password" id="login-pass" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <button onclick="handleLogin()" class="btn btn-gold w-100 mb-3">Acc√©der au Sanctuaire</button>
            <p class="small text-muted" style="cursor:pointer" onclick="handleRegister()">Premi√®re visite ? S'inscrire</p>
        </div>
    </div>
</div>

<div id="view-dashboard">
    <nav class="navbar shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt text-gold me-2"></i> SANCTUM</a>
            <div class="d-flex align-items-center">
                <span class="small text-muted me-3 d-none d-md-block" id="user-email-display">...</span>
                <button onclick="auth.signOut()" class="btn btn-outline-dark btn-sm rounded-0">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <ul class="nav nav-pills justify-content-center mb-5">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tab-expedier', this)">Exp√©dition</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-etiquettes', this)">Bordereaux</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tab-factures', this)">Facturation</a></li>
            
            <li class="nav-item" id="nav-item-admin">
                <a class="nav-link text-danger" href="#" onclick="switchTab('tab-admin', this)">Administration</a>
            </li>
        </ul>

        <div id="tab-expedier" class="tab-section active">
            <div class="row justify-content-center">
                <div class="col-md-7">
                    <div class="card-classic">
                        <div class="card-header-classic">
                            <h4>Nouvelle Requ√™te</h4>
                        </div>
                        
                        <div class="mb-4">
                            <label class="small text-muted text-uppercase fw-bold">Destinataire (Email Sanctum)</label>
                            <input type="email" id="send-dest-email" class="form-control" placeholder="destinataire@sanctum.io">
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="small text-muted text-uppercase fw-bold">Format</label>
                                <select class="form-select" id="send-type" onchange="updateBreakdown()">
                                    <option value="lettre">‚úâÔ∏è Enveloppe (-100g)</option>
                                    <option value="colis_s">üì¶ Standard (-1kg)</option>
                                    <option value="colis_l">üì¶ Volumineux (+5kg)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted text-uppercase fw-bold">Total TTC</label>
                                <div class="form-control bg-light text-end fw-bold" id="price-total">6.50 ‚Ç¨</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between small text-muted mb-4 px-2">
                            <span>Affranchissement Postal : <span id="price-carrier">4.50 ‚Ç¨</span></span>
                            <span>Frais de Service : <span id="price-fee">2.00 ‚Ç¨</span></span>
                        </div>

                        <button onclick="openSecurePayment()" class="btn btn-gold w-100">
                            <i class="fas fa-lock me-2"></i> Proc√©der au Paiement S√©curis√©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-etiquettes" class="tab-section">
            <div class="text-center mb-4">
                <h4 class="text-muted">Vos Documents d'Exp√©dition</h4>
                <p class="small">T√©l√©chargez vos bordereaux, imprimez-les et collez-les sur vos colis.</p>
            </div>
            <div id="list-labels" class="row g-4">Chargement...</div>
        </div>

        <div id="tab-factures" class="tab-section">
            <div class="text-center mb-4">
                <h4 class="text-muted">Historique & Factures</h4>
            </div>
            <div id="list-invoices" class="row g-4">Chargement...</div>
        </div>

        <div id="tab-admin" class="tab-section">
            <div class="card-classic">
                <h4 class="mb-4 text-danger border-bottom pb-2">Vue Administrateur</h4>
                
                <div class="row mb-4 text-center">
                    <div class="col-md-4">
                        <div class="p-3 border bg-light">
                            <small class="text-uppercase text-muted">Chiffre d'Affaires</small>
                            <h3 id="kpi-ca">0 ‚Ç¨</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border bg-light">
                            <small class="text-uppercase text-muted">Co√ªts Postaux</small>
                            <h3 id="kpi-cout" class="text-danger">0 ‚Ç¨</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border bg-light">
                            <small class="text-uppercase text-muted">Marge Brute</small>
                            <h3 id="kpi-marge" class="text-success">0 ‚Ç¨</h3>
                        </div>
                    </div>
                </div>
                
                <button onclick="exportToCSV()" class="btn btn-dark w-100">Exporter le Grand Livre (CSV)</button>
            </div>
        </div>

    </div>
</div>

<div id="secure-payment-modal">
    <div class="payment-window">
        <div class="text-end mb-2"><button class="btn-close" onclick="closePayment()"></button></div>
        
        <h3 class="mb-1 font-serif">Paiement</h3>
        <p class="text-gold small text-uppercase mb-4">Gateway S√©curis√©e SSL</p>
        
        <div class="my-4 py-3 border-top border-bottom">
            <div class="d-flex justify-content-between">
                <span>Total √† r√©gler</span>
                <strong id="pay-amount" class="fs-5">0.00 ‚Ç¨</strong>
            </div>
        </div>

        <div class="text-start mb-3">
            <div class="p-2 border rounded mb-2 bg-light text-muted"><i class="far fa-credit-card me-2"></i> **** **** **** 4242</div>
        </div>

        <button onclick="confirmPayment()" class="btn btn-gold w-100 py-3">Confirmer la Transaction</button>
        <div class="mt-3 small text-muted"><i class="fas fa-lock"></i> Vos donn√©es bancaires sont chiffr√©es.</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
// --- CONFIGURATION ---
const ADMIN_EMAIL = "annelaure.alibert@gmail.com"; 
const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}
const auth = firebase.auth();
const db = firebase.firestore();

const PRICES = { 'lettre': {c:4.5, f:2}, 'colis_s': {c:8.9, f:4}, 'colis_l': {c:15.9, f:6} };
let accountingData = [];

auth.onAuthStateChanged(u => {
    if(u) {
        document.getElementById('view-login').style.display='none';
        document.getElementById('view-dashboard').style.display='block';
        document.getElementById('user-email-display').innerText = u.email;
        
        loadLabels(u); 
        loadInvoices(u);

        if(u.email && u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
            document.getElementById('nav-item-admin').style.display = 'block';
            loadAccounting();
        }
    }
});

function switchTab(id, btn) {
    document.querySelectorAll('.tab-section').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
    btn.classList.add('active');
}

// --- LOGIQUE PRIX ---
function updateBreakdown() {
    const t = document.getElementById('send-type').value;
    const p = PRICES[t];
    document.getElementById('price-carrier').innerText = p.c.toFixed(2)+" ‚Ç¨";
    document.getElementById('price-fee').innerText = p.f.toFixed(2)+" ‚Ç¨";
    document.getElementById('price-total').innerText = (p.c+p.f).toFixed(2)+" ‚Ç¨";
}
function openSecurePayment() {
    if(!document.getElementById('send-dest-email').value) return alert("Veuillez indiquer un destinataire.");
    const t = document.getElementById('send-type').value;
    document.getElementById('pay-amount').innerText = (PRICES[t].c+PRICES[t].f).toFixed(2)+" ‚Ç¨";
    document.getElementById('secure-payment-modal').style.display='block';
}
function closePayment() { document.getElementById('secure-payment-modal').style.display='none'; }

// --- TRANSACTION ---
function confirmPayment() {
    const u = auth.currentUser;
    const dest = document.getElementById('send-dest-email').value;
    const type = document.getElementById('send-type').value;
    const p = PRICES[type];
    const trackCode = "SANCTUM-"+Math.floor(100000 + Math.random() * 900000);
    const invId = "INV-"+Math.floor(Math.random()*10000);

    // Enregistrement
    db.collection('shipments').add({
        sender_uid: u.uid, sender_email: u.email, recipient_email: dest,
        type: type, tracking_code: trackCode, status: 'paid',
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    });

    db.collection('invoices').add({
        user_uid: u.uid, invoice_id: invId, date: new Date().toISOString(), 
        total: p.c+p.f, cost_carrier: p.c, margin_service: p.f,
        items: [{d:`Envoi ${type}`, a:p.c}, {d:"Service Sanctum", a:p.f}],
        created_at: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        closePayment();
        // T√©l√©chargement Auto
        generateRealLabel(trackCode, u.email, dest);
        switchTab('tab-etiquettes', document.querySelectorAll('.nav-link')[1]);
        if(u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) loadAccounting();
    });
}

// --- AFFICHAGE DONNEES ---
function loadLabels(u) {
    db.collection('shipments').where('sender_uid','==',u.uid).orderBy('created_at','desc').onSnapshot(snap => {
        const d = document.getElementById('list-labels'); d.innerHTML='';
        snap.forEach(doc => {
            const data = doc.data();
            d.innerHTML += `
            <div class="col-md-6">
                <div class="card-classic p-3 d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="font-monospace">${data.tracking_code}</strong><br>
                        <small class="text-muted">Vers: ${data.recipient_email}</small>
                    </div>
                    <button class="btn btn-outline-dark btn-sm rounded-0" onclick='generateRealLabel("${data.tracking_code}", "${u.email}", "${data.recipient_email}")'>
                        <i class="fas fa-download"></i> PDF
                    </button>
                </div>
            </div>`;
        });
    });
}

function loadInvoices(u) {
    db.collection('invoices').where('user_uid','==',u.uid).orderBy('created_at','desc').onSnapshot(snap => {
        const d = document.getElementById('list-invoices'); d.innerHTML='';
        snap.forEach(doc => {
            const data = doc.data();
            d.innerHTML += `
            <div class="col-md-6">
                <div class="card-classic p-3 d-flex justify-content-between align-items-center">
                    <div><strong>#${data.invoice_id}</strong><br>${data.total.toFixed(2)} ‚Ç¨</div>
                    <button class="btn btn-outline-dark btn-sm rounded-0" onclick='generateInvoicePDF(${JSON.stringify(data)})'>Facture</button>
                </div>
            </div>`;
        });
    });
}

// --- ADMIN ---
function loadAccounting() {
    if(!auth.currentUser || auth.currentUser.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) return;
    db.collection('invoices').orderBy('created_at', 'desc').onSnapshot(snap => {
        accountingData = []; let ca=0, cout=0, marge=0;
        snap.forEach(doc => {
            const d = doc.data();
            ca += d.total; cout += (d.cost_carrier||0); marge += (d.margin_service||0);
            accountingData.push({d:d.date, i:d.invoice_id, t:d.total, c:d.cost_carrier, m:d.margin_service});
        });
        document.getElementById('kpi-ca').innerText = ca.toFixed(2)+" ‚Ç¨";
        document.getElementById('kpi-cout').innerText = cout.toFixed(2)+" ‚Ç¨";
        document.getElementById('kpi-marge').innerText = marge.toFixed(2)+" ‚Ç¨";
    });
}
function exportToCSV() {
    let csv = "Date;Ref;Total;Cout;Marge\n";
    accountingData.forEach(r => csv += `${r.d};${r.i};${r.t};${r.c};${r.m}\n`);
    const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "Sanctum_Compta.csv"; link.click();
}

// --- GENERATION PDF PREMIUM ---
async function generateRealLabel(code, sender, destEmail) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ format: [100, 150], unit: 'mm' });

    // Design √âtiquette
    doc.setFillColor(20, 20, 20); doc.rect(0,0,100,20,'F'); // Noir profond
    doc.setTextColor(255,255,255); doc.setFontSize(18); doc.setFont("helvetica","bold");
    doc.text("SANCTUM RELAIS", 50, 13, null,null,"center");

    doc.setTextColor(0,0,0); doc.setFontSize(9); doc.setFont("helvetica","normal");
    doc.text(`EXP: ${sender}`, 5, 28);
    doc.line(5, 32, 95, 32);

    doc.setFontSize(12); doc.setFont("helvetica","bold"); doc.text("HUB LOGISTIQUE", 5, 42);
    doc.setFontSize(10); doc.setFont("helvetica","normal"); 
    doc.text("14 Avenue de la Confidentialit√©", 5, 48);
    doc.text("75000 PARIS - FRANCE", 5, 54);

    doc.setDrawColor(0); doc.rect(5, 62, 90, 15);
    doc.setFontSize(9); doc.text("REF CLIENT FINAL:", 7, 67);
    doc.setFont("courier", "bold"); doc.setFontSize(11); doc.text(destEmail, 7, 73);

    const canvas = document.createElement("canvas");
    JsBarcode(canvas, code, {format: "CODE128", displayValue: true, fontSize: 18, height: 40, lineColor: "#000"});
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 5, 85, 90, 30);

    doc.save(`Bordereau_${code}.pdf`);
}

async function generateInvoicePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header Classique
    doc.setFont("times", "bold"); doc.setFontSize(24); doc.setTextColor(20,20,20);
    doc.text("SANCTUM", 105, 20, null, null, "center");
    
    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    doc.text("FACTURE", 105, 28, null, null, "center");

    doc.line(20, 35, 190, 35); // Ligne √©l√©gante

    doc.text("Sanctum Services SAS", 20, 50);
    doc.text("Paris, France", 20, 55);

    doc.text(`Date: ${new Date(data.date).toLocaleDateString()}`, 150, 50);
    doc.text(`R√©f: ${data.invoice_id}`, 150, 55);

    let y = 80;
    doc.setFont("helvetica", "bold"); doc.text("Description", 20, y); doc.text("Montant", 170, y);
    y+=10; doc.line(20, y-5, 190, y-5); 
    doc.setFont("helvetica", "normal");

    data.items.forEach(item => {
        doc.text(item.d, 20, y); doc.text(item.a.toFixed(2)+" ‚Ç¨", 170, y); y+=10;
    });

    y+=10; doc.line(20, y, 190, y); y+=10;
    doc.setFont("helvetica", "bold"); doc.setFontSize(12);
    doc.text("TOTAL TTC", 130, y); doc.text(data.total.toFixed(2)+" ‚Ç¨", 170, y);

    doc.save(`Facture_${data.invoice_id}.pdf`);
}

function handleLogin(){auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
function handleRegister(){auth.createUserWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message))}
</script>
</body>
</html>
