
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPseudoMail - Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 800px; }
        .card { border: none; border-radius: 15px; }
        .email-item { cursor: pointer; transition: background 0.2s; border-left: 4px solid transparent; }
        .email-item:hover { background-color: #f1faff; border-left: 4px solid #0d6efd; }
        .badge-status { font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0 text-primary">ðŸ“¨ MyPseudoMail</h3>
                <small class="text-muted">SystÃ¨me de messagerie temporaire</small>
            </div>
            <span id="status-badge" class="badge bg-warning text-dark badge-status">Connexion...</span>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Votre IdentitÃ©</h5>
            <p class="mb-2">ID Firebase : <code id="user-id" class="bg-light p-1 rounded">En attente...</code></p>
            
            <hr>
            
            <div class="d-grid gap-2">
                <button onclick="simulateIncomingEmail()" class="btn btn-dark">
                    ðŸš€ Simuler la rÃ©ception d'un email (Test)
                </button>
            </div>
            <small class="text-muted d-block mt-2 text-center">Cliquez pour ajouter un faux message dans la base de donnÃ©es.</small>
        </div>
    </div>

    <h5 class="mb-3 ms-1">BoÃ®te de rÃ©ception</h5>
    <div id="inbox-list" class="list-group shadow-sm">
        <div class="list-group-item text-center p-5 text-muted">
            Chargement des messages...
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // --- 1. CONFIGURATION FIREBASE (VOS CLÃ‰S SONT ICI) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC95sX3qXF5JphZpLpnBxZgkLyBNSKBiU8",
    authDomain: "mypseudomail-9d093.firebaseapp.com",
    projectId: "mypseudomail-9d093",
    storageBucket: "mypseudomail-9d093.firebasestorage.app",
    messagingSenderId: "189746859638",
    appId: "1:189746859638:web:abc519c2a17116a32b9957",
    measurementId: "G-8QFN8HSTH8"
  };

  // --- 2. INITIALISATION ---
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentUser = null;

  // --- 3. AUTHENTIFICATION ANONYME ---
  auth.signInAnonymously()
    .then(() => {
        console.log("Utilisateur connectÃ© anonymement.");
    })
    .catch((error) => {
        console.error("Erreur Auth:", error);
        updateStatus("Erreur Connexion", "danger");
    });

  // --- 4. GESTION DE L'Ã‰TAT UTILISATEUR ---
  auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        document.getElementById('user-id').innerText = user.uid;
        updateStatus("ConnectÃ©", "success");
        
        // DÃ©marrer l'Ã©coute des emails
        startInboxListener(user.uid);
    } else {
        updateStatus("DÃ©connectÃ©", "secondary");
    }
  });

  // --- 5. Ã‰COUTE DE LA BASE DE DONNÃ‰ES (TEMPS RÃ‰EL) ---
  function startInboxListener(uid) {
      db.collection('emails')
        .where('to_uid', '==', uid) // Filtre : seulement mes emails
        .orderBy('timestamp', 'desc') // Tri : du plus rÃ©cent au plus vieux
        .onSnapshot((snapshot) => {
            const listDiv = document.getElementById('inbox-list');
            
            if (snapshot.empty) {
                listDiv.innerHTML = `
                    <div class="list-group-item text-center p-5 text-muted">
                        ðŸ“­ Votre boÃ®te est vide.
                    </div>`;
                return;
            }

            let htmlContent = '';
            snapshot.forEach(doc => {
                const mail = doc.data();
                // Conversion date
                let dateStr = "Ã€ l'instant";
                if (mail.timestamp) {
                    dateStr = new Date(mail.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }

                htmlContent += `
                <div class="list-group-item email-item p-3">
                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                        <strong class="text-truncate" style="max-width: 70%;">${mail.subject || '(Sans objet)'}</strong>
                        <small class="text-muted">${dateStr}</small>
                    </div>
                    <div class="small text-primary mb-1">${mail.from}</div>
                    <p class="mb-1 text-muted small text-truncate">${mail.body}</p>
                </div>`;
            });

            listDiv.innerHTML = htmlContent;
        }, (error) => {
            console.error("Erreur Firestore:", error);
            // Souvent causÃ© par des rÃ¨gles de sÃ©curitÃ© manquantes
            if(error.code === 'permission-denied') {
                 alert("Erreur de permission ! VÃ©rifiez les 'RÃ¨gles' dans votre console Firebase.");
            }
        });
  }

  // --- 6. FONCTION DE TEST (ENVOI) ---
  window.simulateIncomingEmail = function() {
      if (!currentUser) return alert("Patience, connexion en cours...");

      const fakeSenders = ["support@google.com", "newsletter@tech.fr", "amis@test.com"];
      const fakeSubjects = ["Code de validation: 1234", "Bienvenue !", "Nouveau message reÃ§u"];
      
      const sender = fakeSenders[Math.floor(Math.random() * fakeSenders.length)];
      const subject = fakeSubjects[Math.floor(Math.random() * fakeSubjects.length)];

      db.collection('emails').add({
          to_uid: currentUser.uid, // IMPORTANT : l'email est taguÃ© avec votre ID
          from: sender,
          subject: subject,
          body: "Ceci est le contenu du message gÃ©nÃ©rÃ© automatiquement pour tester l'application.",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(err => {
          alert("Erreur d'envoi : " + err.message);
      });
  };

  function updateStatus(text, color) {
      const badge = document.getElementById('status-badge');
      badge.innerText = text;
      badge.className = `badge bg-${color} text-white badge-status`;
  }
</script>

</body>
</html>
